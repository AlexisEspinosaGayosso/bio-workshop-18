
### TO BE UPDATED!!

# Required files: inputs
/mnt/s-ws/everyone/Aldrovanda_vesiculosa/AV_R1.fastq
/mnt/s-ws/everyone/Aldrovanda_vesiculosa/AV_R2.fastq
/mnt/s-ws/everyone/Dionaea_muscipula/DM_S20_L001_R1_001.fastq
/mnt/s-ws/everyone/Dionaea_muscipula/DM_S20_L001_R2_001.fastq

# Required files: references
/mnt/s-ws/everyone/Drosera_rotundifolia.fasta
/mnt/s-ws/everyone/Fagopyrum_esculentum.fasta




# Quality control - FastQC

fastqc -o /mnt/s-ws/s-N/myresults /mnt/s-ws/everyone/Drosera_regia/DR_S21_L002_R1_001.fastq




# Cleaning - Trimmomatic
# Usually: Remove low quality regions from reads, and remove adapters
# /mnt/s-ws/everyone/Trimmomatic-0.36/adapters/all.fa

java -jar /mnt/s-ws/everyone/Trimmomatic-0.36/trimmomatic-0.36.jar PE input_forward.fq.gz input_reverse.fq.gz output_forward_paired.fq.gz output_forward_unpaired.fq.gz output_reverse_paired.fq.gz output_reverse_unpaired.fq.gz ILLUMINACLIP:/mnt/s-ws/everyone/Trimmomatic-0.36/adapters/all.fa:2:30:10 LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:36




# Alignment against reference - bowtie2
cp /mnt/s-ws/everyone/Drosera_rotundifolia.fasta /mnt/s-ws/s-N/
# OR
cp /mnt/s-ws/everyone/Fagopyrum_esculentum.fasta /mnt/s-ws/s-N/
cd /mnt/s-ws/s-N

bowtie2-build Drosera_rotundifolia.fasta Drosera_ref  # output .bt2

bowtie2 -k 5 -x Drosera_ref -1 your_input_R1.fastq -2 your_input_R2.fastq -S All_output.sam --al-conc Hitting_reads.fastq

# -k 5 report 5 best alignments (default: only the highest scoring one!!)
# --al-conc Get all pairs that align in Hitting_reads.1.fastq and Hitting_reads.2.fastq, we can use those for assembly later
# --no-unal Don't write unaligning reads to All_output.sam, we don't care about those
# IMPORTANT TO USE -k 5 - otherwise duplicated genes will appear once lost!




# Compress to bam file
samtools view -bS All_output.sam > All_output.bam
rm *.sam #optional




# Check which genes are covered by reads - bedtools
bedtools intersect -a /mnt/s-ws/everyone/Drosera_rotundifolia.gff3 -b All_output.bam -wao
# -wao : report the number of bases overlapping

# Check whether any reads don't align to our given genes - bedtools
bedtools genomecov -ibam All_output.bam -bga | head

# Get all genes that have parts with no reads aligning by comparing with the annotation gff3 - bedtools
# For Drosera:
bedtools genomecov -ibam All_output.bam -bga | awk '$4 == 0' | bedtools intersect -a /mnt/s-ws/everyone/Drosera_rotundifolia.gff3 -b - -loj -f 1 | less
bedtools genomecov -ibam All_output.bam -bga | awk '$4 == 0' | bedtools intersect -a /mnt/s-ws/everyone/Drosera_rotundifolia.gff3 -b - -loj -f 1 | grep -v "\-1"
bedtools genomecov -ibam All_output.bam -bga | awk '$4 == 0' | bedtools intersect -a /mnt/s-ws/everyone/Drosera_rotundifolia.gff3 -b - -loj -f 0.7 | grep -v "\-1" | grep gene | cut -f 4 | sort | uniq
bedtools genomecov -ibam All_output.bam -bga | awk '$4 == 0' | bedtools intersect -a /mnt/s-ws/everyone/Drosera_rotundifolia.gff3 -b - -loj -f 0.5 | grep -v "\-1" | grep gene | cut -f 4 | sort | uniq




# ASSEMBLY - Velvet or SPAdes or Organelle Assembler or NOVOplasty

# 1.VELVET
velveth kmer29_velvet_Assembly 29 -shortPaired -fastq -separate Hitting_reads.1.fastq Hitting_reads.2.fastq
#
velvetg kmer29_velvet_Assembly -exp_cov 100 -min_contig_lgth 2000 -ins_length 300 -cov_cutoff 50 -clean yes

# 2. SPADES
spades.py -o kmer29_Spades_assembly -1 Hitting_reads.1.fastq -2 Hitting_reads.2.fastq -k 29




# ANNOTATION
# web interfaces - skipping




# ALIGNMENT with references - Mummer

run-mummer3 Fagopyrum_esculentum.fasta your_assembly OUTPUT
# OR
run-mummer3 Drosera_rotundifolia.fasta your_assembly OUTPUT
mummerplot -png -p mummer OUTPUT.out   # plotting





# SNP Calling - samtools + bcftools

# Sorting BAM file
samtools sort All_output.bam All_output_sorted

# Indexing
samtools index All_output_sorted.bam

# SNP calling
samtools mpileup -uf YOUR_REFERENCE.fasta All_output_sorted.bam | bcftools view -bvcg - > var.raw.bcf  
bcftools view var.raw.bcf | /usr/share/samtools/vcfutils.pl varFilter -D100 > var.flt.vcf  

